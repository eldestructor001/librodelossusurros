<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Noche de los Susurros en Arboleas ‚Äî Libro Digital</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Estilo adicional para el cron√≥metro fijo */
    #timer-container {
      margin-top: 15px;
      /* Ajuste para la nueva posici√≥n */
    }

    /* Adaptaci√≥n para la secci√≥n final del tiempo en grande */
    #finalResultDisplay {
      font-family: 'Blackadder ITC', cursive;
    }

    /* Clases para aplicar estilos de fuente y tama√±o en sec0 si no se cargan correctamente in-line */
    .blackadder-white-left {
      font-family: 'Blackadder ITC', cursive;
      color: #fff;
      text-align: left;
      line-height: 1.2;
      font-size: 28px;
    }

    /* Nuevo estilo para el bot√≥n de regreso */
    .backBtn {
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--muted);
      padding: 6px 12px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .backBtn:hover {
      border-color: #fff;
      color: #fff;
    }

    /* Estilo para el nuevo bot√≥n de Ubicaci√≥n */
    .location-button {
      background-color: #007bff;
      /* Un color de mapa m√°s est√°ndar, o ajustado al tema */
      background-image: linear-gradient(45deg, #1c73a4, #007bff);
      border: none;
      color: white;
      padding: 10px 20px;
      font-size: 20px;
      margin-top: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .location-button:hover {
      box-shadow: 0 4px 20px rgba(0, 123, 255, 0.6);
      background-image: linear-gradient(45deg, #007bff, #1c73a4);
    }

    /* Estilo para el bot√≥n de Finalizar Ritual que aparece al final */
    #btnStartFinal {
      font-size: 24px;
      padding: 15px 30px;
      background-color: var(--accent);
      background-image: linear-gradient(45deg, #b33, #8c2828);
      color: white;
      border: none;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(179, 51, 51, 0.5);
    }
  </style>
</head>

<body>
  <div class="app" role="application">
    <header style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
      <div style="flex-grow: 1;">
        <!-- MODIFICADO: Nombre del evento -->
        <h1>La Noche de los Susurros en Arboleas</h1>
        <p class="lead">Sigue las pistas, completa los retos y rompe la maldici√≥n antes de medianoche.</p>
      </div>
      <div id="timer-container">
        <span id="team-display" style="font-size: 20px; color: #fff; margin-bottom: 5px; display: block;"></span>
        <span id="timer-label">Tiempo:</span>
        <span id="timer">00:00:00</span>
      </div>
    </header>

    <div class="panel" id="startPanel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Equipo</div>
          <input id="teamName" type="text" placeholder="Nombre del equipo (p.ej. Los Valientes)" />
        </div>
        <div style="text-align:right">
        </div>
      </div>
      <div class="controls">
        <button id="btnStart">Comenzar el ritual</button>
      </div>
      <div class="status" id="status">Pulsa <strong>Comenzar el ritual</strong> para iniciar el cron√≥metro y desbloquear
        la primera prueba.</div>
    </div>

    <div id="flow" class="hide">

      <div class="panel section" id="sec0">
        <h3>üìú La Voz de la Noche</h3>
        <div class="prompt">
          <div class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; line-height: 1.2;">
            <p style="margin: 0 0 15px 0; font-size: 28px;">Esta noche, las almas de Arboleas buscan su voz.</p>
            <p style="margin: 0; font-size: 28px;">Cuatro guardianes os esperan.</p>
            <p style="margin: 0 0 15px 0; font-size: 28px;">Completad el Libro de los Susurros antes de la media noche...
            </p>
            <p style="margin: 0; font-size: 28px;">O su eco os arrastrar√° al olvido.</p>
          </div>
        </div>

        <!-- MODIFICADO: Panel de navegaci√≥n que se renderiza con JS -->
        <div id="sectionSelector"
          style="margin-top:25px; text-align: center; display: none; padding: 15px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
          <h4>Selecciona el Guardi√°n a visitar:</h4>
          <div id="guardianButtonsContainer" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Botones se a√±aden aqu√≠ con JS -->
          </div>
          <!-- NUEVO: Bot√≥n de finalizaci√≥n que solo aparece cuando todas las secciones est√°n completas -->
          <button id="btnStartFinal" onclick="goToFinalCountdown()" style="display: none; margin-top: 25px;">Finalizar
            Ritual</button>
        </div>

      </div>

      <div class="panel section" id="sec1">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <!-- Bot√≥n de Ubicaci√≥n -->
        <button class="location-button" onclick="openLocation(1)">Ver Ubicaci√≥n de Guardi√°n 1</button>

        <h3>üîÆ Guardi√°n 1</h3>
        <div class="prompt">
          <!-- MODIFICADO: Acertijo del Guardi√°n 1 (Tu sombra) -->
          <pre style="white-space: pre-wrap; background:rgba(0,0,0,0.3);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)">No tengo ojos, pero siempre te miro.

No tengo voz, pero oyes mi suspiro.

Sigo tus pasos en la noche callada,

y si te giras‚Ä¶ ya no hay nada.

¬øQu√© soy?</pre>
        </div>
        <label>Respuesta (escribe en min√∫sculas)</label>
        <input id="ans1" type="text" autocomplete="off" />
        <div style="margin-top:8px">
          <button onclick="check1()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(1)">Pista (+2 min)</button>
        </div>
        <div id="msg1" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <!-- MODIFICADO: Texto de la pista y estilo -->
        <div id="hint1" class="hint-message"
          style="display: none; font-family: 'Blackadder ITC', cursive; color: var(--accent);">Es tuya y la ves todos
          los d√≠as</div>
        <div id="reward1" class="result hide"></div>
      </div>

      <div class="panel section" id="sec2">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <!-- Bot√≥n de Ubicaci√≥n -->
        <button class="location-button" onclick="openLocation(2)">Ver Ubicaci√≥n de Guardi√°n 2</button>

        <!-- MODIFICADO: Nombre del guardi√°n -->
        <h3>üî™ Guardi√°n 2</h3>
        <div class="prompt">
          <p class="blackadder-gray-left"
            style="font-family: 'Blackadder ITC', cursive; color: var(--muted); text-align: left; margin: 5px 0; font-size: 24px;">
            Mi voz retumba en piedra y metal, solo el eco sabr√° si hablas bien o mal</p>
          <p class="blackadder-white-right"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: right; margin: 5px 0; font-size: 24px;">
            ¬°Para seguir con vida, tendr√©is que demostrar que el miedo no os hace torpes!</p>
          <p class="blackadder-gray-left"
            style="font-family: 'Blackadder ITC', cursive; color: var(--muted); text-align: left; margin: 5px 0; font-size: 24px;">
            Si encontr√°is el n√∫mero correcto, os dar√© el camino al muerto que despierta...</p>
        </div>
        <label>Introduce el n√∫mero que has encontrado</label>
        <input id="ans2" type="text" autocomplete="off" />
        <div style="margin-top:8px">
          <button onclick="check2()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(2)">Pista (+2 min)</button>
        </div>
        <div id="msg2" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <div id="reward2" class="result hide"></div>
        <div id="hint2" class="hint-message"
          style="display: none; font-family: 'Blackadder ITC', cursive; color: var(--accent);">Buscad por la zona, es la
          √∫nica pista</div>
      </div>

      <div class="panel section" id="sec3">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <!-- Bot√≥n de Ubicaci√≥n -->
        <button class="location-button" onclick="openLocation(3)">Ver Ubicaci√≥n de Guardi√°n 3</button>

        <!-- MODIFICADO: Nombre del guardi√°n -->
        <h3>üßü Guardi√°n 3</h3>
        <div class="prompt">
          <!-- MODIFICADO: 'El muerto' cambiado a 'Un muerto' -->
          <p class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; margin: 5px 0; font-size: 20px;">
            Un muerto te mira con ojos huecos.</p>
          <p class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; margin: 5px 0; font-size: 20px;">
            Su voz no pide cerebro, sino redenci√≥n</p>
          <p class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; margin: 5px 0; font-size: 20px;">
            Cuando su acertijo se resuelve, deja una pista</p>
          <p class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; margin: 5px 0; font-size: 20px;">
            que apunta al siguiente destino</p>
        </div>
        <p class="small">Acertijo (resuelve en voz alta o escribe el n√∫mero):</p>
        <pre
          style="white-space: pre-wrap; background:rgba(0,0,0,0.3);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)">Tres tumbas hay en el campo,
en una descansa un alma, en otra dos,
y la tercera espera al siguiente grupo.

Si cada noche los muertos se levantan y duplican su n√∫mero,
¬øcu√°ntas almas vagar√°n al tercer amanecer?</pre>
        <label>Tu respuesta (n√∫mero)</label>
        <input id="ans3" type="text" autocomplete="off" />
        <div style="margin-top:8px">
          <button onclick="check3()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(3)">Pista (+2 min)</button>
        </div>
        <div id="msg3" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <div id="reward3" class="result hide"></div>
        <div id="hint3" class="hint-message"
          style="display: none; font-family: 'Blackadder ITC', cursive; color: var(--accent);">el primer amanecer son 6
          almas y el segundo 12</div>
      </div>

      <div class="panel section" id="sec4">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <!-- Bot√≥n de Ubicaci√≥n -->
        <button class="location-button" onclick="openLocation(4)">Ver Ubicaci√≥n de Guardi√°n 4</button>

        <!-- MODIFICADO: Nombre del guardi√°n -->
        <h3>‚õìÔ∏è Guardi√°n 4</h3>
        <div class="prompt">
          <!-- MODIFICADO: Nuevo texto y acertijo m√°s simple y terror√≠fico -->
          <p class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; margin: 5px 0; font-size: 20px;">
            La Dama Encadenada os susurra desde su prisi√≥n de sombras. Solo un n√∫mero abrir√° las puertas de su celda:</p>
          <pre
            style="white-space: pre-wrap; background:rgba(0,0,0,0.3);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)">En la casa de los lamentos,
seis velas arden sin fin.
Si una se apaga por la brisa helada,
y tres m√°s son consumidas por la angustia.
¬øCu√°ntas velas quedan de pie en el candelabro?</pre>
        </div>

        <label>Introduce la respuesta (un solo n√∫mero)</label>
        <input id="ans4" type="text" autocomplete="off" />

        <div style="margin-top:8px">
          <button onclick="check4()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(4)">Pista (+2 min)</button>
        </div>

        <div id="msg4" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <!-- MODIFICADO: Pista actualizada para el nuevo acertijo -->
        <div id="hint4" class="hint-message"
          style="display: none; font-family: 'Blackadder ITC', cursive; color: var(--accent);">
          Cuenta solo las que NO se han apagado o consumido.
        </div>
        <div id="reward4" class="result hide"></div>
      </div>

      <!-- NUEVA SECCI√ìN: Solo para la cuenta atr√°s final -->
      <div class="panel section" id="sec_final_countdown">
        <div style="margin-bottom: 15px; text-align: right;">
            <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <h3>üîî Vuelo Final</h3>
        <p style="font-family: 'Blackadder ITC', cursive; font-size: 24px; color: var(--accent); margin: 0;">¬°Corred!
          Deb√©is volver a la plaza del ayuntamiento</p>
        
        <div style="border: 2px solid var(--accent); padding: 20px; border-radius: 10px; background: rgba(179, 51, 51, 0.1); margin: 20px 0; text-align: center;">
            <h2 id="finalTimerDisplay" style="font-size: 60px; color: #fff; margin: 0;">05:00</h2>
            <p style="font-size: 18px; color: var(--muted); margin: 10px 0 0 0;">Tiempo l√≠mite para regresar.</p>
        </div>
        
        <button id="btnFinishRitual" onclick="finishRun()" style="font-size: 22px; padding: 12px 25px; margin-top: 20px;">He regresado al inicio ‚Äî Marcar tiempo</button>
      </div>


      <div class="panel section" id="sec5">
        <div style="margin-bottom: 15px; text-align: right;">
            <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <h3>‚úÖ Ritual Completado</h3>
        <div class="prompt">¬°La maldici√≥n se ha roto! Vuestro valor y astucia han sido suficientes.</div>
        <p class="small">Vuestro tiempo oficial ha sido registrado. Mostrad esta pantalla al Guardi√°n de Meta.</p>
        
        <div id="finalResultDisplay"
          style="text-align: center; padding: 20px; border: 2px solid var(--accent); border-radius: 10px; background: rgba(179, 51, 51, 0.1); margin-top: 20px;">
        </div>
      </div>

    </div>

    <footer>Dise√±ado para <strong>La Noche de los Susurros en Arboleas</strong> ‚Äî versi√≥n m√≥vil. Mant√©n el m√≥vil en
      silencio para no romper la ambientaci√≥n.</footer>
  </div>

  <script>
    // Variables y configuraci√≥n
    let startTs = null;
    let elapsedBefore = 0;
    let timerInterval = null;
    let countdownInterval = null; // Nuevo para el temporizador de 5 min
    let hintsUsed = 0;
    let teamName = '';

    // NUEVO: Array para rastrear qu√© secciones est√°n completadas
    // Se utiliza para mostrar/ocultar los botones del selector y habilitar el bot√≥n final
    const completedSections = {
      1: false,
      2: false,
      3: false,
      4: false
    };

    // MODIFICADO: Etiqueta de los Guardianes simplificada
    const sectionDetails = {
        1: { id: 'sec1', label: 'Guardi√°n 1' }, 
        2: { id: 'sec2', label: 'Guardi√°n 2' },
        3: { id: 'sec3', label: 'Guardi√°n 3' },
        4: { id: 'sec4', label: 'Guardi√°n 4' }
    };

    // MODIFICADO: Respuesta 4 ahora es un solo n√∫mero (2, porque 1+3=4 se apagan de 6)
    const correct = {
      1: ['tu sombra', 'sombra', 'tusombra'], // Guardi√°n 1
      2: '13', // Guardi√°n 2
      3: '24', // Guardi√°n 3
      4: '2' // Guardi√°n 4: 6 velas - 1 apagada - 3 consumidas = 2 quedan encendidas/en pie.
    };

    const locationUrls = {
      1: 'https://maps.app.goo.gl/2EafbzYGXRCtRmyS7',
      2: 'https://maps.app.goo.gl/bMndTrHzv4xrkr6TA',
      3: 'https://maps.app.goo.gl/iTJCapCmPxauYwGY6',
      4: 'https://maps.app.goo.gl/HoyvxAuguCb3fxY57'
    };


    // ----------------------------------------------------
    // Funciones de utilidad
    // ----------------------------------------------------

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const sec = totalSeconds % 60;
      const min = Math.floor(totalSeconds / 60) % 60;
      const hr = Math.floor(totalSeconds / 3600);
      return `${String(hr).padStart(2, '0')}:${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function startTimer() {
      startTs = Date.now();
      timerInterval = setInterval(() => {
        const now = Date.now();
        // Se suma la penalizaci√≥n (120000ms = 2 minutos)
        document.getElementById('timer').textContent = formatTime(now - startTs + elapsedBefore + hintsUsed * 120000);
      }, 250);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    function useHint() {
      hintsUsed++;
      alert('Pista utilizada. Penalizaci√≥n: +2 minutos en el tiempo final.');
    }

    // Funci√≥n para mostrar la pista con el texto especial
    function showHint(sectionNum) {
      if (!completedSections[sectionNum]) { // Solo penaliza si la secci√≥n no est√° completada
        useHint(); 
      }
      
      let hintText = '';
      switch (sectionNum) {
        case 1:
          hintText = "Es tuya y la ves todos los d√≠as";
          break;
        case 2:
          hintText = "Buscad por la zona, es la √∫nica pista";
          break;
        case 3:
          hintText = "el primer amanecer son 6 almas y el segundo 12";
          break;
        case 4:
          // MODIFICADO: Pista actualizada
          hintText = "Cuenta solo las que NO se han apagado o consumido.";
          break;
        default:
          return;
      }

      const hintEl = document.getElementById(`hint${sectionNum}`);
      if (hintEl) {
        hintEl.textContent = hintText;
        hintEl.style.display = 'block';
      }
    }

    // Funci√≥n para ir a cualquier secci√≥n y actualizar el selector al volver a sec0
    function goToSection(sectionId) {
      // Primero, oculta todas las secciones
      const sections = ['sec0', 'sec1', 'sec2', 'sec3', 'sec4', 'sec_final_countdown', 'sec5'];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      // Si volvemos al selector, lo actualizamos
      if (sectionId === 'sec0') {
        renderSectionSelector();
      }

      // Luego, muestra la secci√≥n objetivo
      const targetEl = document.getElementById(sectionId);
      if (targetEl) {
        targetEl.style.display = 'block';
        targetEl.scrollIntoView({
          behavior: 'smooth'
        });
      }
    }

    // NUEVO: Funci√≥n para abrir la ubicaci√≥n de Google Maps
    function openLocation(guardianNum) {
      const url = locationUrls[guardianNum];
      if (url) {
        window.open(url, '_blank');
      } else {
        alert('Ubicaci√≥n no disponible.');
      }
    }

    // NUEVA FUNCI√ìN: Renderiza los botones del selector din√°micamente
    function renderSectionSelector() {
      const container = document.getElementById('guardianButtonsContainer');
      const btnFinal = document.getElementById('btnStartFinal');
      container.innerHTML = '';
      let allCompleted = true;

      for (const num in sectionDetails) {
        const detail = sectionDetails[num];
        const isCompleted = completedSections[num];

        if (!isCompleted) {
          allCompleted = false; // Si falta alguna, el ritual no est√° listo
          // Crear bot√≥n solo para secciones incompletas
          const button = document.createElement('button');
          // MODIFICADO: Usa la etiqueta simple sin descripci√≥n
          button.textContent = detail.label; 
          button.onclick = () => goToSection(detail.id);
          container.appendChild(button);
        } else {
            // Opcional: Mostrar un mensaje de completado para esa secci√≥n
            const completedMessage = document.createElement('div');
            completedMessage.innerHTML = `<span style="color:#00AA00; font-weight: bold;">‚úÖ ${detail.label} completado.</span>`;
            completedMessage.style.padding = '5px 0';
            completedMessage.style.borderBottom = '1px solid rgba(0,255,0,0.1)';
            container.appendChild(completedMessage);
        }
      }
      
      // Mostrar u ocultar el bot√≥n Finalizar Ritual
      if (allCompleted) {
          container.innerHTML = `<p style="color: var(--accent); font-weight: bold;">¬°Los 4 Guardianes han sido silenciados!</p>`;
          btnFinal.style.display = 'block';
      } else {
          btnFinal.style.display = 'none';
      }
    }
    
    // Funci√≥n para el bot√≥n "Finalizar Ritual" que inicia la cuenta atr√°s
    function goToFinalCountdown() {
        goToSection('sec_final_countdown');
        startFinalCountdown(300); // 300 segundos = 5 minutos
    }

    // Funci√≥n que se llama al resolver una secci√≥n
    function markSectionCompleted(num) {
        if (!completedSections[num]) {
            completedSections[num] = true;
            alert(`¬°Guardi√°n ${num} completado! Volviendo al selector.`);
            goToSection('sec0'); // Volver al selector para actualizar los botones
        }
    }


    // Oculta todas las secciones al cargar la p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      const sections = ['sec0', 'sec1', 'sec2', 'sec3', 'sec4', 'sec_final_countdown', 'sec5'];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      // Inicializar el selector para que no est√© vac√≠o si no se ha iniciado el juego
      renderSectionSelector(); 
    });

    // ----------------------------------------------------
    // Al pulsar ‚ÄúComenzar ritual‚Äù
    // ----------------------------------------------------
    function btnStartClick() {
      const teamNameInput = document.getElementById('teamName');
      teamName = (teamNameInput && teamNameInput.value.trim()) || '';

      if (!teamName) {
        alert('‚ö†Ô∏è ¬°Debes introducir el nombre del equipo para comenzar el ritual!');
        return;
      }

      const teamDisplay = document.getElementById('team-display');
      if (teamDisplay) {
        teamDisplay.textContent = teamName;
      }

      const startPanel = document.getElementById('startPanel');
      if (startPanel) startPanel.style.display = 'none';

      const flow = document.getElementById('flow');
      if (flow) flow.classList.remove('hide');

      // Mostrar sec0 y el selector de secciones
      goToSection('sec0');
      document.getElementById('sectionSelector').style.display = 'block';
      renderSectionSelector(); // Asegurar que el selector se muestre correctamente

      if (typeof startTimer === 'function') startTimer();

      const status = document.getElementById('status');
      if (status) {
        status.textContent = 'El cron√≥metro ha comenzado. Seguid las pistas y completad las pruebas.';
      }
    }

    // ----------------------------------------------------
    // Check 1 (Guardi√°n 1 - Tu sombra)
    // ----------------------------------------------------
    function check1() {
      if (completedSections[1]) {
          document.getElementById('msg1').textContent = 'Ya hab√©is resuelto este guardi√°n.';
          return;
      }
      // Aseguramos que la respuesta se compara sin espacios internos ni may√∫sculas
      const val = document.getElementById('ans1').value.toLowerCase().trim().replace(/\s/g, ''); 
      const ok = correct[1].includes(val);
      const msg = document.getElementById('msg1');
      if (ok) {
        msg.innerHTML = '<span style="color: var(--accent); font-weight: bold;">¬°Guardi√°n silenciado! Pista de la Sombra registrada.</span>';
        document.getElementById('reward1').innerHTML = `<div style="margin-top: 10px;"><button class="backBtn" onclick="markSectionCompleted(1)">Continuar ‚Üí</button></div>`;
        document.getElementById('reward1').classList.remove('hide');
        document.getElementById('hint1').style.display = 'none';
      } else {
        msg.textContent = 'La respuesta se desvanece en la oscuridad. Intenta de nuevo.';
      }
    }

    // ----------------------------------------------------
    // Check 2 (Guardi√°n 2 - N√∫mero 13)
    // ----------------------------------------------------
    function check2() {
      if (completedSections[2]) {
          document.getElementById('msg2').textContent = 'Ya hab√©is resuelto este guardi√°n.';
          return;
      }
      const val = document.getElementById('ans2').value.trim();
      const msg = document.getElementById('msg2');
      if (val === correct[2]) {
        msg.innerHTML = '<span style="color: var(--accent); font-weight: bold;">¬°Guardi√°n silenciado! Pista del Cr√°neo registrada.</span>';
        document.getElementById('reward2').innerHTML = `<div style="margin-top: 10px;"><button class="backBtn" onclick="markSectionCompleted(2)">Continuar ‚Üí</button></div>`;
        document.getElementById('reward2').classList.remove('hide');
        document.getElementById('hint2').style.display = 'none';
      } else {
        msg.textContent = 'El eco no os da la respuesta. Volved a mirar.';
      }
    }

    // ----------------------------------------------------
    // Check 3 (Guardi√°n 3 - N√∫mero 24)
    // ----------------------------------------------------
    function check3() {
      if (completedSections[3]) {
          document.getElementById('msg3').textContent = 'Ya hab√©is resuelto este guardi√°n.';
          return;
      }
      const val = document.getElementById('ans3').value.trim();
      const msg = document.getElementById('msg3');
      if (val === correct[3]) {
        msg.innerHTML = '<span style="color: var(--accent); font-weight: bold;">¬°Guardi√°n silenciado! Pista del Muerto registrada.</span>';
        document.getElementById('reward3').innerHTML = `<div style="margin-top: 10px;"><button class="backBtn" onclick="markSectionCompleted(3)">Continuar ‚Üí</button></div>`;
        document.getElementById('reward3').classList.remove('hide');
        document.getElementById('hint3').style.display = 'none';
      } else {
        msg.textContent = 'El muerto no se conforma. Recalculad los huesos.';
      }
    }

    // ----------------------------------------------------
    // Check 4 (Guardi√°n 4 - Acertijo de Velas: respuesta 2)
    // ----------------------------------------------------
    function check4() {
      if (completedSections[4]) {
          document.getElementById('msg4').textContent = 'Ya hab√©is resuelto este guardi√°n.';
          return;
      }
      // Se compara la respuesta con el nuevo valor '2'
      const val = document.getElementById('ans4').value.toLowerCase().trim().replace(/\s/g, '');
      const msg = document.getElementById('msg4');
      const ok = val === correct[4];

      if (ok) {
        msg.innerHTML = '<span style="color: var(--accent); font-weight: bold;">¬°Guardi√°n silenciado! El Libro de los Susurros est√° completo.</span>';
        document.getElementById('reward4').innerHTML = `<div style="margin-top: 10px;"><button class="backBtn" onclick="markSectionCompleted(4)">Continuar ‚Üí</button></div>`;
        document.getElementById('reward4').classList.remove('hide');
        document.getElementById('hint4').style.display = 'none';
        
        // Ocultar los campos de respuesta y botones de la secci√≥n 4
        document.getElementById('ans4').style.display = 'none';
        document.querySelector('#sec4 > div[style*="margin-top:8px"]').style.display = 'none'; 

      } else {
        msg.textContent = 'La Dama sigue encadenada, su n√∫mero es incorrecto. Vuelve a contar las llamas.';
      }
    }

    // ----------------------------------------------------
    // Timer Final (5 minutos)
    // ----------------------------------------------------
    function startFinalCountdown(durationInSeconds) {
      let timer = durationInSeconds;
      const display = document.getElementById('finalTimerDisplay');

      if (countdownInterval) clearInterval(countdownInterval);

      countdownInterval = setInterval(() => {
        const minutes = parseInt(timer / 60, 10);
        const seconds = parseInt(timer % 60, 10);

        const displayTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        display.textContent = displayTime;

        if (--timer < 0) {
          clearInterval(countdownInterval);
          display.textContent = "¬°Tiempo de vuelta agotado!";
        }
      }, 1000);
    }


    // ----------------------------------------------------
    // Finish Run (Finalizaci√≥n)
    // ----------------------------------------------------
    function finishRun() {
      stopTimer();
      if (countdownInterval) clearInterval(countdownInterval);

      const now = Date.now();
      // Se suma la penalizaci√≥n (hintsUsed * 120000ms)
      const raw = (now - startTs + elapsedBefore + hintsUsed * 120000);
      const finalTime = formatTime(raw);

      // Ocultar el timer fijo de la esquina
      document.getElementById('timer-container').style.display = 'none';

      // Ocultar la secci√≥n actual (sec_final_countdown) y mostrar solo sec5
      document.getElementById('sec_final_countdown').style.display = 'none';
      goToSection('sec5'); // Muestra la secci√≥n final

      // Generar el contenido final (Solo nombre, tiempo e im√°genes)
      const finalResultDisplay = document.getElementById('finalResultDisplay');
      finalResultDisplay.innerHTML = `
          <div style="font-family: 'Blackadder ITC', cursive; color: #fff;">
              <h4 style="font-size: 36px; margin: 0 0 10px 0;">${teamName}</h4>
              <h1 style="font-size: 80px; color: var(--accent); margin: 0 0 20px 0;">${finalTime}</h1>
              
              <!-- Contenedor vertical apilado -->
              <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 30px;">
                  <!-- IMAGEN DE ARBOLEAS: Eliminado border-radius: 50%; y border: 3px solid var(--accent); para que no sea circular -->
                  <img src="arboleas.png" onerror="this.onerror=null; this.src='https://placehold.co/120x120/121213/b33?text=ARBOLEAS'" alt="Escudo de Arboleas" style="height: 120px; width: auto;">
                  <img src="sincabeza.png" onerror="this.onerror=null; this.src='https://placehold.co/60x60/121213/9a9a9a?text=LOGO'" alt="Logo de la Empresa" style="height: 60px; width: auto;">
              </div>
              <p style="font-size: 20px; color: var(--muted); margin-top: 20px;">Penalizaci√≥n por pistas: ${hintsUsed * 2} min</p>
          </div>
      `;
      finalResultDisplay.style.display = 'block';

      // Ocultar el bot√≥n original de finishRun
      const finishButton = document.querySelector('#sec5 button');
      if (finishButton) finishButton.style.display = 'none';

      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // start button
    document.getElementById('btnStart').addEventListener('click', btnStartClick);
  </script>
</body>

</html>

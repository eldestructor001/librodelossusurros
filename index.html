<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Noche de los Susurros en Hu√©rcal ‚Äî Libro Digital</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Adaptaci√≥n para la secci√≥n final del tiempo en grande */
    #finalResultDisplay {
      font-family: 'Blackadder ITC', cursive;
    }

    /* Estilo para el texto principal del Hub (sec0) */
    .blackadder-white-left {
      font-family: 'Blackadder ITC', cursive;
      color: #fff;
      text-align: left;
      line-height: 1.2;
      font-size: 28px;
    }

    /* ‚ùó NUEVOS ESTILOS PARA LOS PROMPTS DE TEXTO ‚ùó */
    /* Estilo para el texto blanco alineado a la izquierda (Por defecto) */
    .white-left-text {
        color: #fff;
        font-size: 24px; /* ‚ùó TAMA√ëO AUMENTADO A 24PX ‚ùó */
        margin-top: 10px;
        line-height: 1.5;
        text-align: left;
    }

    /* Estilo para el texto gris alineado a la derecha */
    .grey-right-text {
      color: var(--muted);
      font-size: 24px; /* ‚ùó TAMA√ëO AUMENTADO A 24PX ‚ùó */
      margin-top: 10px;
      line-height: 1.5;
      text-align: right; 
    }
    
    /* Estilo para el texto gris alineado a la izquierda */
    .grey-left-text {
        color: var(--muted);
        font-size: 24px; /* ‚ùó TAMA√ëO AUMENTADO A 24PX ‚ùó */
        margin-top: 10px;
        line-height: 1.5;
        text-align: left;
    }

    /* Nuevo estilo para el bot√≥n de regreso */
    .backBtn {
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--muted);
      padding: 6px 12px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .backBtn:hover {
      border-color: #fff;
      color: #fff;
    }
    
    /* ‚ùó NUEVO ESTILO PARA EL BOT√ìN DE UBICACI√ìN M√ÅS GRANDE (misma tipograf√≠a) ‚ùó */
    .locationBtn {
        display: inline-block;
        padding: 12px 25px; 
        font-size: 18px; 
        font-weight: bold;
        color: #fff; 
        background-color: var(--accent);
        background-image: linear-gradient(45deg, #cc4444, #aa3333); 
        border: none;
        border-radius: 6px;
        text-decoration: none; 
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(170, 51, 51, 0.4);
    }

    .locationBtn:hover {
        background-color: #aa3333;
        background-image: linear-gradient(45deg, #aa3333, #882222);
        box-shadow: 0 6px 15px rgba(170, 51, 51, 0.6);
    }


    /* Estilo para el bot√≥n de Finalizar Ritual que aparece al final */
    #btnStartFinal {
      font-size: 24px;
      padding: 15px 30px;
      background-color: var(--accent);
      background-image: linear-gradient(45deg, #b33, #8c2828);
      color: white;
      border: none;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(179, 51, 51, 0.5);
    }

    /* --- ESTILOS DEL MODAL PERSONALIZADO --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: #18181a;
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 25px rgba(179, 51, 51, 0.6);
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-message {
      font-family: Inter, sans-serif;
      font-size: 20px;
      color: #fff;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .modal-title {
      font-family: 'Blackadder ITC', cursive;
      font-size: 32px;
      color: var(--accent);
      margin-top: 0;
      margin-bottom: 15px;
    }

    .modal-button {
      background: var(--accent);
      border: none;
      color: #fff;
      padding: 10px 20px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-family: Inter, sans-serif;
      font-weight: bold;
    }

    .modal-button:hover {
      background: #8c2828;
    }
  </style>
</head>

<body>
  <div id="customAlert" class="modal-overlay">
    <div class="modal-content">
      <div id="modalTitle" class="modal-title"></div>
      <div id="modalMessage" class="modal-message"></div>
      <button class="modal-button" onclick="closeCustomAlert()">Entendido</button>
    </div>
  </div>


  <div class="app" role="application">
    <header style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
      <div style="flex-grow:1;">
        <h1>La Noche de los Susurros en Hu√©rcal</h1>
        <p class="lead">Sigue las pistas, completa los retos y rompe la maldici√≥n antes de medianoche.</p>
      </div>
      <div id="timer-container">
        <span id="team-display" style="font-size:20px;color:#fff;display:block;"></span>
        <span id="timer-label">Tiempo:</span> <span id="timer">00:00</span>
      </div>
    </header>

    <div class="panel" id="startPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="small">Equipo</div>
          <input id="teamName" type="text" placeholder="Nombre del equipo (p.ej. Los Valientes)" />
        </div>
      </div>
      <div class="controls">
        <button id="btnStart">Comenzar el ritual</button>
      </div>
      <div class="status" id="status">Pulsa <strong>Comenzar el ritual</strong> para iniciar el cron√≥metro y desbloquear la primera prueba.</div>
    </div>

    <div id="flow" class="hide">

      <div class="panel section" id="sec0">
        <h3>üìú La Voz de la Noche</h3>
        <audio controls class="dark-audio-player" src="assets/audio/S0.mp3"></audio>
        <div class="prompt">
          <div class="blackadder-white-left"
            style="font-family: 'Blackadder ITC', cursive; color: #fff; text-align: left; line-height: 1.2; margin-bottom: 20px;">
            <p style="margin: 0 0 15px 0; font-size: 28px;">Esta noche, las almas de Hu√©rcal buscan su voz.</p>
            <p style="margin: 0; font-size: 28px;">Cuatro guardianes os esperan.</p>
            <p style="margin: 0 0 15px 0; font-size: 28px;">Completad el Libro de los Susurros antes de la media noche...</p>
            <p style="margin: 0; font-size: 28px;">O su eco os arrastrar√° al olvido.</p>
          </div>
          <div class="grey-right-text" style="margin-top: 15px; font-style: italic;">
              <p style="margin: 0;">El eco del pasado a√∫n susurra entre muros dormidos.</p>
              <p style="margin: 0;">Donde el viento se enreda con la tierra morena,</p>
              <p style="margin: 0;">una voz antigua aguarda entre sombras y polvo.</p>
              <p style="margin: 0;">All√≠ hallar√°s a quien ve lo que otros temen mirar</p>
          </div>
        </div>

        <div id="sectionSelector"
          style="margin-top:25px; text-align: center; display: none; padding: 15px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
          <h4>Selecciona el Guardi√°n a visitar:</h4>
          <div id="guardianButtonsContainer" style="display: flex; flex-direction: column; gap: 10px;">
            </div>
          <button id="btnStartFinal" onclick="goToFinalCountdown()" style="display: none; margin-top: 25px;">Finalizar Ritual</button>
        </div>
      </div>


      <div class="panel section" id="sec1">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <div class="location-container" style="margin-bottom: 20px; text-align: center;">
            <a href="https://maps.app.goo.gl/2K5fLpVPjRyz1yE99" class="locationBtn" target="_blank">üó∫Ô∏è Buscar Ubicaci√≥n</a>
        </div>
        <h3>üîÆ Guardi√°n 1 ‚Äî La Pitonisa</h3>
        <audio controls class="dark-audio-player" src="assets/audio/S1.mp3"></audio>
        <div class="prompt">
            <p class="white-left-text">
                En el viejo cortijo, una pitonisa contempla una esfera de luz. Su mirada atraviesa el tiempo, pero solo si sois capaces de ver lo que ella ve.
            </p>
            <p class="grey-right-text">
                Tres caminos muestran vuestro destino: la sangre, la pureza o el vac√≠o. Solo uno revela el camino a seguir‚Ä¶ escr√≠belo, y hallar√°s el camino al siguiente guardi√°n.
            </p>
            <p class="white-left-text" style="margin-top: 25px; font-style: italic;">
                En la noche me prendo sin llama,<br>
                ti√±o las manos del que toca el misterio.<br>
                Me alimento de heridas y de rabia,<br>
                se√±alo el final del camino y la advertencia en el pecho.<br>
                Los vivos me buscan, los muertos me conocen.<br>
                ¬øQu√© soy?
            </p>
        </div>

        <label>Respuesta</label>
        <input id="ans1" type="text" autocomplete="off" />
        <div style="margin-top:8px">
          <button onclick="check1()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(1)">Pista (Suma 2 min)</button>
        </div>
        <div id="msg1" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <div id="reward1" class="result hide"></div>
      </div>

      <div class="panel section" id="sec2">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <div class="location-container" style="margin-bottom: 20px; text-align: center;">
            <a href="https://maps.app.goo.gl/9Ke5vw5rPiTibB9w6" class="locationBtn" target="_blank">üó∫Ô∏è Buscar Ubicaci√≥n</a>
        </div>
        <h3>üî™ Guardi√°n 2 ‚Äî T√∫nel del Eco Carmes√≠</h3>
        <audio controls class="dark-audio-player" src="assets/audio/S2.mp3"></audio>
        <div class="prompt">
            <p class="grey-left-text">
                Mi voz retumba en piedra y metal, solo el eco sabr√° si hablas bien o mal
            </p>
            <p class="white-left-text" style="text-align: right; margin-top: 15px;">
                ¬°Para seguir con vida, tendr√©is que demostrar que el miedo no os hace torpes!
            </p>
            <p class="grey-left-text">
                Si encontr√°is el n√∫mero correcto en este t√∫nel, os dar√© el camino al muerto que despierta...
            </p>
        </div>

        <label>Introduce el n√∫mero que has encontrado</label>
        <input id="ans2" type="text" autocomplete="off" />
        <div style="margin-top:8px">
          <button onclick="check2()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(2)">Pista (Suma 2 min)</button>
        </div>
        <div id="msg2" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <div id="reward2" class="result hide"></div>
      </div>

      <div class="panel section" id="sec3">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <div class="location-container" style="margin-bottom: 20px; text-align: center;">
            <a href="https://maps.app.goo.gl/YUHDjCQkAZTQb4Gf6" class="locationBtn" target="_blank">üó∫Ô∏è Buscar Ubicaci√≥n</a>
        </div>
        <h3>üßü Guardi√°n 3 ‚Äî El Silencio del Muerto</h3>
        <audio controls class="dark-audio-player" src="assets/audio/S3.mp3"></audio>
        <pre
          style="white-space: pre-wrap; background:rgba(0,0,0,0.3);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)">Tres tumbas hay en el campo,
en una descansa un alma, en otra dos,
y la tercera espera al siguiente grupo.
Si cada noche los muertos se duplican,
¬øcu√°ntas almas vagar√°n al tercer amanecer?</pre>
        <input id="ans3" type="text" autocomplete="off" />
        <div style="margin-top:8px">
          <button onclick="check3()">Enviar respuesta</button>
          <button class="hintBtn" onclick="showHint(3)">Pista (Suma 2 min)</button>
        </div>
        <div id="msg3" class="small" style="margin-top:8px;color:#f2f2f2"></div>
        <div id="reward3" class="result hide"></div>
      </div>

      <div class="panel section" id="sec4">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <div class="location-container" style="margin-bottom: 20px; text-align: center;">
            <a href="https://maps.app.goo.gl/wWLTZj9hhyLF98Ar7" class="locationBtn" target="_blank">üó∫Ô∏è Buscar Ubicaci√≥n</a>
        </div>
        <h3>‚õìÔ∏è Guardi√°n 4 ‚Äî La Monja del Silencio</h3>
        <audio controls class="dark-audio-player" src="assets/audio/S4.mp3"></audio>
        <div class="prompt">
            <p class="white-left-text">
                Detr√°s de los barrotes la monja reza en la oscuridad. Deb√©is encontrar el s√≠mbolo de Hu√©rcal: una moneda con su escudo, y marcar que la hab√©is encontrado.
            </p>
            <p class="grey-right-text">
                En el lugar hay una moneda escondida que podr√©is recuperar. Cuando la teng√°is, marcadlo abajo.
            </p>
        </div>
        
        <div style="margin-top:20px; text-align: center;">
          <p id="check4-label" style="color: #fff; margin-bottom: 15px; font-weight: bold;">¬øHab√©is encontrado la moneda?</p>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="checkCoin(true)" style="background-color: var(--accent); border: 1px solid var(--accent); color: white;">S√≠, la he encontrado</button>
            <button onclick="checkCoin(false)" class="backBtn">No, a√∫n no la encuentro</button>
          </div>
        </div>
        
        <div style="margin-top:20px; text-align: center;">
          <button class="hintBtn" onclick="showHint(4)">Pista (Suma 2 min)</button>
        </div>
        <div id="msg4" class="small" style="margin-top:8px;color:#f2f2f2; text-align: center;"></div>
        <div id="reward4" class="result hide"></div>
      </div>

      <div class="panel section" id="sec_final_countdown">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <h3>üèÉ Final ‚Äî ¬°Regresad al teatro!</h3>
        <div class="prompt">¬°Corred! Deb√©is volver al teatro multiusos.</div>

        <div id="finalCountdown" style="margin-top:20px;text-align:center;border:1px solid var(--accent);padding:15px;border-radius:8px;">
          <p style="font-family:'Blackadder ITC';font-size:24px;color:var(--accent);">Cuenta atr√°s para el regreso</p>
          <h2 id="finalTimerDisplay" style="font-size:48px;color:#fff;">05:00</h2>
          <button id="btnFinishRitual" onclick="finishRun()">He regresado al inicio ‚Äî Marcar tiempo</button>
        </div>
      </div>

      <div class="panel section" id="sec5">
        <div style="margin-bottom: 15px; text-align: right;">
          <button class="backBtn" onclick="goToSection('sec0')">‚Üê Volver a Selecci√≥n</button>
        </div>
        <h3>üîî Final ‚Äî Regreso al punto de inicio</h3>
        <button onclick="finishRun()">He regresado al inicio ‚Äî marcar tiempo</button>
        <div id="finalResultDisplay" style="display:none;"></div>
      </div>
    </div>

    <footer>Dise√±ado para <strong>La Noche de los Susurros en Hu√©rcal</strong> ‚Äî versi√≥n m√≥vil.</footer>
  </div>

  <script>
    let startTs=null, elapsedBefore=0, timerInterval=null, countdownInterval=null, hintsUsed=0, teamName='';
    
    // Respuestas de Hu√©rcal (La clave 4 ya no se usa para checkear)
    const correct={
      1:['rojo'],
      2:'13',
      3:'24',
      4:'99' // Se mantiene la clave 4, aunque ya no se usa para el check, solo para la estructura
    };
    
    // üîπ L√ìGICA DEL HUB üîπ
    const completedSections = {
      1: false, // Pitonisa
      2: false, // T√∫nel
      3: false, // Muerto
      4: false  // Monja (Nuevo)
    };

    // Etiquetas de Hu√©rcal y 4 Guardianes
    const sectionDetails = {
      1: {
        id: 'sec1',
        label: 'Guardi√°n 1 ‚Äî La Pitonisa'
      },
      2: {
        id: 'sec2',
        label: 'Guardi√°n 2 ‚Äî T√∫nel del Eco Carmes√≠'
      },
      3: {
        id: 'sec3',
        label: 'Guardi√°n 3 ‚Äî El Silencio del Muerto'
      },
      4: {
        id: 'sec4',
        label: 'Guardi√°n 4 ‚Äî La Monja del Silencio'
      }
    };
    
    // Lista de todas las secciones
    const allSectionIds = ['sec0', 'sec1', 'sec2', 'sec3', 'sec4', 'sec_final_countdown', 'sec5'];


    // ----------------------------------------------------
    // Funciones de utilidad para el Modal Personalizado
    // ----------------------------------------------------
    function showCustomAlert(message, title = "Aviso del Libro") {
      const modal = document.getElementById('customAlert');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      modalTitle.textContent = title;
      modalMessage.innerHTML = message;
      modal.classList.add('show');
    }

    function closeCustomAlert() {
      const modal = document.getElementById('customAlert');
      modal.classList.remove('show');
    }

    // --- Funciones del temporizador ---
    function formatTime(ms){
        const totalSeconds = Math.floor(ms / 1000);
        const sec = totalSeconds % 60;
        const min = Math.floor(totalSeconds / 60) % 60;
        const hr = Math.floor(totalSeconds / 3600);
        // Formato H:MM:SS
        return `${String(hr).padStart(2, '0')}:${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function startTimer(){
        startTs=Date.now();
        timerInterval=setInterval(()=>{
            const now=Date.now();
            document.getElementById('timer').textContent=formatTime(now-startTs+hintsUsed*120000);
        },250);
    }
    
    function stopTimer(){clearInterval(timerInterval);}
    
    function useHint(){
      hintsUsed++;
    }

    // Pistas (Ajustadas a Hu√©rcal)
    function showHint(n){
      if (completedSections[n]) {
        showCustomAlert('Ya hab√©is resuelto este guardi√°n. No se necesita pista.', '‚õî Advertencia');
        return;
      }
      useHint();
      
      const hints = {
        1: 'Del color de la sangre', 
        2: 'Buscad por el t√∫nel', 
        3: 'El primer amanecer son 6 almas y el segundo 12',
        4: 'El n√∫mero est√° justo delante de sus barrotes.' // Pista para Guardi√°n 4
      };
      
      const hintText = hints[n] || "Pista no disponible.";

      const modalMessage = `
        <p style="color: var(--accent); font-weight: bold; font-size: 22px; margin-bottom: 15px;">
          Penalizaci√≥n: +2 minutos
        </p>
        <p style="font-family: 'Blackadder ITC', cursive; font-size: 26px;">
          "${hintText}"
        </p>
      `;
      showCustomAlert(modalMessage, `üóùÔ∏è Pista de Guardi√°n ${n}`);
    }

    // Ocultar secciones al inicio
    window.addEventListener('DOMContentLoaded',()=>allSectionIds.forEach(id=>document.getElementById(id).style.display='none'));

    // üîπ L√ìGICA DE NAVEGACI√ìN Y HUB üîπ

    // Renderiza los botones del hub
    function renderSectionSelector() {
      const container = document.getElementById('guardianButtonsContainer');
      const btnFinal = document.getElementById('btnStartFinal');
      container.innerHTML = '';
      let allCompleted = true;

      for (const num in sectionDetails) {
        const detail = sectionDetails[num];
        const isCompleted = completedSections[num];

        if (!isCompleted) {
          allCompleted = false;
          const button = document.createElement('button');
          button.textContent = detail.label;
          button.onclick = () => goToSection(detail.id); 
          container.appendChild(button);
        } else {
          const completedMessage = document.createElement('div');
          completedMessage.innerHTML =
            `<span style="color:#00AA00; font-weight: bold;">‚úÖ ${detail.label} silenciado.</span>`;
          completedMessage.style.padding = '5px 0';
          completedMessage.style.borderBottom = '1px solid rgba(0,255,0,0.1)';
          container.appendChild(completedMessage);
        }
      }

      // 4 Guardianes completados
      if (allCompleted) { 
        container.innerHTML =
          `<p style="color: var(--accent); font-weight: bold;">¬°Los 4 Guardianes han sido silenciados!</p>`;
        btnFinal.style.display = 'block';
      } else {
        btnFinal.style.display = 'none';
      }
    }

    // Marca una secci√≥n como completada y vuelve al hub
    function markSectionCompleted(n) {
      if (!completedSections[n]) {
        completedSections[n] = true;
        showCustomAlert(`¬°Guardi√°n ${n} silenciado! Has completado el reto. Volviendo al selector.`, '‚úÖ Reto Superado');
        goToSection('sec0'); // sec0 es ahora el Hub
      }
    }

    // Inicia la cuenta atr√°s final
    function goToFinalCountdown() {
      goToSection('sec_final_countdown');
      startFinalCountdown(300); // 300 segundos = 5 minutos
    }


    // Funci√≥n de Inicio (Modificada para ir a sec0/Hub)
    function btnStartClick(){
      const input=document.getElementById('teamName');
      teamName=(input&&input.value.trim())||'';
      if(!teamName){
        showCustomAlert('<strong>¬°Debes introducir el nombre del equipo</strong> para comenzar el ritual!', '‚ö†Ô∏è Falta Nombre');
        return;
      }
      document.getElementById('team-display').textContent=teamName;
      document.getElementById('startPanel').classList.add('hide');
      document.getElementById('flow').classList.remove('hide');
      
      // Ir al HUB (sec0) y mostrar el selector
      goToSection('sec0'); 
      document.getElementById('sectionSelector').style.display = 'block'; // Mostrar el selector del Hub
      renderSectionSelector(); // Asegurar que los botones se carguen

      startTimer();
    }
    document.getElementById('btnStart').addEventListener('click',btnStartClick);

    // goToSection
    function goToSection(id){
      allSectionIds.forEach(s=>{
        const el=document.getElementById(s);
        if(el) el.style.display=s===id?'block':'none';
      });
      
      // Si volvemos al hub, lo recargamos
      if (id === 'sec0') {
        renderSectionSelector();
        document.getElementById('sectionSelector').style.display = 'block';
      }
      window.scrollTo({top:0,behavior:'smooth'});
    }


    // üîπ COMPROBACIONES (CHECKS) üîπ

    function check1(){
      if (completedSections[1]) { document.getElementById('msg1').textContent = 'Ya hab√©is resuelto este guardi√°n.'; return; }
      const v=document.getElementById('ans1').value.toLowerCase().trim();
      const msg = document.getElementById('msg1');
      const reward = document.getElementById('reward1');
      if(correct[1].includes(v)){
        // ‚ùó Bot√≥n movido a reward ‚ùó
        msg.textContent='';
        reward.innerHTML = '<p style="color:white; margin-bottom:15px; font-weight:bold;">‚úÖ La pitonisa asiente. Pista desbloqueada.</p><div style="text-align:right;"><button style="background-color: white; color: var(--accent); border: 2px solid white; border-radius: 6px; padding: 10px 20px; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#eee\'" onmouseout="this.style.backgroundColor=\'white\'" onclick="markSectionCompleted(1)">Continuar ‚Üí</button></div>';
        reward.classList.remove('hide');
      }else{
        msg.textContent='La luz vacila: prueba otra vez.';
        reward.classList.add('hide');
      }
    }

    function check2(){
      if (completedSections[2]) { document.getElementById('msg2').textContent = 'Ya hab√©is resuelto este guardi√°n.'; return; }
      const v=document.getElementById('ans2').value.trim();
      const msg = document.getElementById('msg2');
      const reward = document.getElementById('reward2');
      if(v===correct[2]){
        // ‚ùó Bot√≥n movido a reward ‚ùó
        msg.textContent='';
        reward.innerHTML = '<p style="color:white; margin-bottom:15px; font-weight:bold;">‚úÖ ¬°Respuesta correcta! El hombre de la motosierra se aparta.</p><div style="text-align:right;"><button style="background-color: white; color: var(--accent); border: 2px solid white; border-radius: 6px; padding: 10px 20px; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#eee\'" onmouseout="this.style.backgroundColor=\'white\'" onclick="markSectionCompleted(2)">Continuar ‚Üí</button></div>';
        reward.classList.remove('hide');
      }else{
        msg.textContent='El eco no os da la respuesta.';
        reward.classList.add('hide');
      }
    }
    
    function check3(){
      if (completedSections[3]) { document.getElementById('msg3').textContent = 'Ya hab√©is resuelto este guardi√°n.'; return; }
      const v=document.getElementById('ans3').value.trim();
      const msg = document.getElementById('msg3');
      const reward = document.getElementById('reward3');
      if(v===correct[3]){
        // ‚ùó Bot√≥n movido a reward ‚ùó
        msg.textContent='';
        reward.innerHTML = '<p style="color:white; margin-bottom:15px; font-weight:bold;">‚úÖ ¬°Respuesta correcta! El muerto os entrega su secreto.</p><div style="text-align:right;"><button style="background-color: white; color: var(--accent); border: 2px solid white; border-radius: 6px; padding: 10px 20px; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#eee\'" onmouseout="this.style.backgroundColor=\'white\'" onclick="markSectionCompleted(3)">Continuar ‚Üí</button></div>';
        reward.classList.remove('hide');
      }else{
        msg.textContent='El muerto no se conforma.';
        reward.classList.add('hide');
      }
    }

    // ‚ùó NUEVA FUNCI√ìN PARA EL GUARDI√ÅN 4 (MONEDA) ‚ùó
    function checkCoin(found){
      if (completedSections[4]) { document.getElementById('msg4').textContent = 'Ya hab√©is resuelto este guardi√°n.'; return; }
      const msg = document.getElementById('msg4');
      const reward = document.getElementById('reward4');
      
      // Limpiar el mensaje previo
      msg.textContent = '';
      
      if (found === true) {
        // ‚ùó Bot√≥n movido a reward ‚ùó
        reward.innerHTML='<p style="color:white; margin-bottom:15px; font-weight:bold;">‚úÖ ¬°La moneda! La monja os entrega el pergamino.</p><div style="text-align:right;"><button style="background-color: white; color: var(--accent); border: 2px solid white; border-radius: 6px; padding: 10px 20px; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#eee\'" onmouseout="this.style.backgroundColor=\'white\'" onclick="markSectionCompleted(4)">Continuar ‚Üí</button></div>';
        reward.classList.remove('hide');
      } else {
        msg.textContent='A√∫n no la encontr√°is. Seguid buscando.';
        reward.classList.add('hide');
      }
    }


    // üîπ L√ìGICA FINAL (Cuenta atr√°s) üîπ
    function startFinalCountdown(s){
      let t=s;
      const disp=document.getElementById('finalTimerDisplay');
      if(countdownInterval)clearInterval(countdownInterval);
      
      countdownInterval=setInterval(()=>{
        const m=parseInt(t/60,10),sec=parseInt(t%60,10);
        disp.textContent=`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        if(--t<0){
          clearInterval(countdownInterval);
          disp.textContent="¬°Tiempo agotado!";
        }
      },1000);
    }
    
    function finishRun(){
      stopTimer();
      if(countdownInterval)clearInterval(countdownInterval);
      
      const now=Date.now(),raw=(now-startTs+hintsUsed*120000),time=formatTime(raw);
      
      document.getElementById('timer-container').style.display = 'none';
      
      goToSection('sec5');

      const finalResultDisplay = document.getElementById('finalResultDisplay');
      finalResultDisplay.style.display='block';
      
      // Output final
      finalResultDisplay.innerHTML=`
        <div style="background: #1e1e20; padding: 25px; border-radius: 12px; border: 2px solid var(--accent); margin-top: 20px; text-align: center; color: #fff;">
              <h4 style="font-size: 36px; margin: 0 0 10px 0;">${teamName}</h4>
              <h1 style="font-size: 80px; color: var(--accent); margin: 0 0 20px 0;">${time}</h1>
              
              <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 30px;">
                  <img src="huercal.png" onerror="this.onerror=null; this.src='https://placehold.co/200x120/121213/b33?text=HUERCAL'\" alt="Escudo de Hu√©rcal" style="height: 120px; width: auto; border-radius: 4px;">
                  <img src="sincabeza.png" onerror="this.onerror=null; this.src='https://placehold.co/60x60/121213/9a9a9a?text=LOGO'\" alt="Logo de la Empresa" style="height: 60px; width: auto;">
              </div>
              <p style="font-size: 20px; color: var(--muted); margin-top: 20px;">Penalizaci√≥n por pistas: ${hintsUsed * 2} min</p>
          </div>
      `;
        
      // Ocultar bot√≥n "He regresado" de la secci√≥n 5
      const finishButton = document.querySelector('#sec5 > button');
      if (finishButton) finishButton.style.display = 'none';
    }
  </script>
</body>
</html>